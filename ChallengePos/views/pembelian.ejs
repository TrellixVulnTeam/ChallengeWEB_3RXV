<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Soppeng Admin</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../public/assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="../public/assets/vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="../public/assets/vendors/select2/select2.min.css">
    <link rel="stylesheet" href="../public/assets/vendors/select2-bootstrap-theme/select2-bootstrap.min.css">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="../public/assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="../public/assets/images/favicon.png" />
</head>

<body>
    <!-- form -->
    <div class="col-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Pembelian Barang</h4>
                <form class="forms-sample">
                    <div class="form-group">
                        <label for="id_barang">ID Supplier</label>
                        <select class="form-control" id="id_supplier">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_gudang">ID Gudang</label>
                        <select class="form-control" id="id_gudang">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_barang">ID Operator</label>
                        <select class="form-control" id="id_supplier">

                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tanggal_pembelian">Tanggal Pembelian</label>
                        <input type="date" class="form-control" id="tanggal_pembelian">
                    </div>
                    <div class="form-group">
                        <label for="total_harga">Total Harga Beli</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-primary text-white">Rp</span>
                            </div>
                            <input type="text" class="form-control" aria-label="amount" id="total_harga">
                            <div class="input-group-append">
                                <span class="input-group-text">.00</span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mr-2">Submit</button>
                    <button class="btn btn-dark">Cancel</button>
                </form>
            </div>
        </div>
    </div>

    <!-- table -->
    <div class="card">
        <div class="card-body">
            <h4 class="card-title">Daftar Pembelian Barang</h4>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th> No.</th>
                            <th> No.Invoice Pembelian</th>
                            <th> Tanggal Pembelian </th>
                            <th> Total Harga Beli</th>
                            <th> ID Gudang</th>
                            <th> ID Supplier</th>
                            <th> ID Operator</th>
                        </tr>
                    </thead>
                    <tbody id="pembelian">
                    </tbody>
                </table>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th> No Detail</th>
                                <th> No.Invoice Pembelian</th>
                                <th> Barcode </th>
                                <th> Qty</th>
                                <th> Harga Beli</th>
                                <th> Total Harga</th>
                            </tr>
                        </thead>
                        <tbody id="detail_pembelian">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="../public/assets/vendors/js/vendor.bundle.base.js"></script>
<!-- endinject -->
<!-- Plugin js for this page -->
<script src="../public/assets/vendors/select2/select2.min.js"></script>
<script src="../public/assets/vendors/typeahead.js/typeahead.bundle.min.js"></script>
<!-- End plugin js for this page -->
<!-- inject:js -->
<script src="../public/assets/js/off-canvas.js"></script>
<script src="../public/assets/js/hoverable-collapse.js"></script>
<script src="../public/assets/js/misc.js"></script>
<script src="../public/assets/js/settings.js"></script>
<script src="../public/assets/js/todolist.js"></script>
<!-- endinject -->
<!-- Custom js for this page -->
<script src="../public/assets/js/file-upload.js"></script>
<script src="../public/assets/js/typeahead.js"></script>
<script src="../public/assets/js/select2.js"></script>
<!-- End custom js for this page -->


<script>
    const readData = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3001/pembelian",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (pembelian) {
            let data1 = pembelian[0]
            console.log(data1)
            let html = ''
            data1.forEach((item, index) => {
                html += `
        <tr>
            <td>${index + 1}</td>
            <td><a href="#">${item.no_invoice}</a></td>
            <td>${item.tanggal}</td>
            <td>${item.total_harga}</td>
            <td>${item.id_supplier}</td>
            <td>${item.id_gudang}</td>
            <td>${item.id_operator}</td>
          <td>
            <button type="button" class="btn btn-success btn-icon-text" id_data="${item.no_invoice}"><i class="mdi mdi-file-check btn-icon-append"></i></button>
            <button type="button" class="btn btn-danger btn-icon-delete" id_data="${item.no_invoice}"><i class="mdi mdi-trash-can btn-icon-append"></i></button>
          </td>
        </tr>
        `
            });
            

            let data2 = pembelian[1]
            console.log('data2', data2)
            let detail = ''
            data2.forEach((item, index) => {
                detail += `
        <tr>
            <td>${item.id_detail}</td>
            <td>${item.no_invoice}</td>
            <td>${item.barcode}</td>
            <td>${item.qty}</td>
            <td>${item.harga_beli}</td>
            <td>${item.total_harga}</td>
        </tr>
        `
            });
            $('#detail_pembelian').html(detail)
            $('#pembelian').html(html)


        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery')
        })
    }

    const saveData = (id_satuan, nama_satuan, keterangan) => {
        $.ajax({
            method: "POST",
            url: `http://localhost:3001/satuan`,
            dataType: "json",
            headers: {
                json: true
            },
            data: { id_satuan, nama_satuan, keterangan }
        }).done(function (response) {
            readData()
            $("#form-tambah").trigger("reset");
        }).fail(function (err) {
            alert('gagal pake jquery save')
        })
    }

    const readSelectOperator = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3001/pembelian/operator",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const readSelectGudang = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3001/pembelian/gudang",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const readSelectSupplier = () => {
        $.ajax({
            method: "GET",
            url: "http://localhost:3001/pembelian/supplier",
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (rows) {

            let html = ''
            rows.forEach((item, index) => {
                html += `
        <option value="${item.id_barang}">
         ${item.id_barang} - ${item.nama_barang}
        </option>
        `
            });
            $('form select').html(html)
        }).fail(function (err) {
            console.log("error", err)
            alert('gagal jquery tambah salah satu ID')
        })
    }

    const editData = (id) => {
        $.ajax({
            method: "GET",
            url: `http://localhost:3001/pembelian/${id}`,
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (data) {
            console.log(data[0].sell_price)
            $('#barcodeedit').val(data[0].barcode)
            $('#nama_varianedit').val(data[0].varian_name)
            $('#stokedit').val(data[0].stok)
            $('#buy_priceedit').val(parseInt(data[0].buy_price))
            $('#sell_priceedit').val(parseInt(data[0].sell_price))
            $('#id_barangedit').val(data[0].id_barang)
        }).fail(function (err) {
            alert('gagal pake jquery')
        })
    }

    const deleteData = (id) => {
        $.ajax({
            method: "DELETE",
            url: `http://localhost:3001/pembelian/${id}`,
            dataType: "json",
            headers: {
                json: true
            }
        }).done(function (response) {

            readData()
        }).fail(function (err) {
            alert('gagal pake jquery delete')
        })
    }

    $(document).ready(function () {
        readData()
        // readSelect()

        $('#form-tambah').submit(function (event) {
            event.preventDefault();
            const id_satuan = $('#id_satuan').val()
            const nama_satuan = $('#nama_satuan').val()
            const keterangan = $('#keterangan_satuan').val()
            saveData(id_satuan, nama_satuan, keterangan)

        })

        $('#form-edit').submit(function (event) {
            event.preventDefault();
            $.ajax({
                url: `http://localhost:3001/pembelian/${barcode}`,
                type: 'PUT',
                headers: {
                    json: true
                },
                // Form data
                data: new FormData($('#form-edit')[0]),
                cache: false,
                contentType: false,
                processData: false,

            }).then((data) => {

                $("#form-edit").trigger("reset");
                alert('data edit berhasil tersave');
                readData()
            }).fail((err) => {
                alert('data gagal tersave')

            })
        })

        $('table tbody').on('click', '.btn-icon-text', function () {
            const id = $(this).attr('id_data')
            editData(id)

        })

        $('table tbody').on('click', '.btn-icon-delete', function () {
            const id = $(this).attr('id_data')
            deleteData(id)
        })

        $('#reset-form-tambah').click(function () {
            $("#form-tambah").trigger("reset");
            readData()
        })

        $('#reset-form-edit').click(function () {
            $("#form-edit").trigger("reset");
            readData()
        })



    })
</script>

</html>